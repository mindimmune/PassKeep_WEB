$(document).ready ->
  new Clipboard('.copy-btn',
    text: (trigger) ->
      $(trigger).closest('tr').find('.note-val').val()
  )

angular.module('pass_keep', ['ngRoute', 'templates'])
.controller('securityNotesListController',
  ($scope, $http)->
    $http.get('<%= Rails.application.routes.url_helpers.test_path %>').then (response) ->
      $scope.notes = JSON.stringify(response.data)
).controller('securityNotesController',
  ($scope, $http)->
    $scope.newNote = ->
      $http.get('<%= Rails.application.routes.url_helpers.new_security_note_path %>').then (response) ->
        $scope.note = response.data
        angular.forEach $scope.note.values, (value, key)->
          $scope.note.values[key].valType = if value.hidden then "password" else "text"
    $scope.changeValueType = (note)->
      note.valType = if note.hidden then "password" else "text"
    $scope.submit = ->
      $scope.submitted = true;
      if $scope.noteForm.$valid
        $http.post('<%= Rails.application.routes.url_helpers.security_notes_path %>', {security_note: $scope.note})
          .then (response) ->
            if response.data.success
              $('#noteModalForm').modal('hide')
              $('#notes-list-lnk')
                .prop('title', '<%= I18n.t("sidebar.note_added")%>')
                .tooltip('fixTitle')
                .tooltip('show')
              setTimeout (->
                $('#notes-list-lnk').tooltip('hide')
              ), 3000
    $scope.hasError = (field, validation) ->
      if validation
        return $scope.noteForm[field].$dirty and $scope.noteForm[field].$error[validation] or
          $scope.submitted and $scope.noteForm[field].$error[validation]
      $scope.noteForm[field].$dirty and $scope.noteForm[field].$invalid or
        $scope.submitted and $scope.noteForm[field].$invalid
).config ($routeProvider)->
  $routeProvider.when("/notes-list",
    {
      templateUrl: "views/notes-list.html",
      controller: "securityNotesListController",
      controllerAs: "securNotesListCtrl"
    }
  );
